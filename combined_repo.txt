

##### .env.example #####

# --- PostgreSQL Container Configuration ---
POSTGRES_USER=myuser
POSTGRES_PASSWORD=mysecretpassword
POSTGRES_DB=webudget_db

# --- WeBudget API Configuration ---
# This URL uses the variables from above to prevent mismatches.
DATABASE_URL="postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}"

# Application Port
PORT=3000

# Other secrets...
PLAID_CLIENT_ID=
PLAID_SECRET=
JWT_SECRET=
ENCRYPTION_KEY=

##### .flowbite-react/.gitignore #####

class-list.json
pid

##### .flowbite-react/config.json #####

{
  "$schema": "https://unpkg.com/flowbite-react/schema.json",
  "components": [],
  "dark": true,
  "prefix": "",
  "path": "src/components",
  "tsx": true,
  "rsc": true
}

##### .gitignore #####

node_modules
dist
.DS_Store
vite.config.ts.*
*.tar.gz.env
.env

##### .replit #####

modules = ["nodejs-20", "web", "postgresql-16"]
run = "npm run dev"
hidden = [".config", ".git", "generated-icon.png", "node_modules", "dist"]

[nix]
channel = "stable-24_05"

[deployment]
deploymentTarget = "autoscale"
build = ["npm", "run", "build"]
run = ["npm", "run", "start"]

[[ports]]
localPort = 5000
externalPort = 80

[workflows]
runButton = "Project"

[[workflows.workflow]]
name = "Project"
mode = "parallel"
author = "agent"

[[workflows.workflow.tasks]]
task = "workflow.run"
args = "Start application"

[[workflows.workflow]]
name = "Start application"
author = "agent"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "npm run dev"
waitForPort = 5000


##### .vscode/extensions.json #####

{
  "recommendations": [
    "bradlc.vscode-tailwindcss"
  ]
}

##### .vscode/settings.json #####

{
  "files.associations": {
    "*.css": "tailwindcss"
  },
  "tailwindCSS.classAttributes": [
    "class",
    "className",
    "theme"
  ],
  "tailwindCSS.experimental.classRegex": [
    [
      "twMerge\\(([^)]*)\\)",
      "[\"'`]([^\"'`]*).*?[\"'`]"
    ],
    [
      "createTheme(?:<\\w+>)?\\s*\\(([^)]*)\\)",
      "{?\\s?[\\w].*:\\s*?[\"'`]([^\"'`]*).*?,?\\s?}?"
    ]
  ]
}

##### README.md #####

# WeBudget - Personal Finance Management

A full-stack personal finance management application designed to provide users with a consolidated view of their financial accounts, built with a focus on operational excellence and scalability.

---

## Table of Contents

- [WeBudget - Personal Finance Management](#webudget---personal-finance-management)
  - [Table of Contents](#table-of-contents)
  - [Project Overview](#project-overview)
  - [Technology Stack](#technology-stack)
  - [Getting Started](#getting-started)
    - [Prerequisites](#prerequisites)
    - [Step 1: Configuration](#step-1-configuration)
    - [Step 2: Launch \& Verification](#step-2-launch--verification)
  - [Project Structure](#project-structure)
  - [API Documentation](#api-documentation)
  - [Advanced Operations](#advanced-operations)
  - [Troubleshooting](#troubleshooting)

---

## Project Overview

The WeBudget monorepo contains the source code for the entire application suite. The backend is a secure, containerized Node.js API that serves as the single source of truth for all client applications (web, mobile).

---

## Technology Stack

-   **Runtime:** Node.js with TypeScript
-   **Framework:** Express.js
-   **Database:** PostgreSQL
-   **Containerization:** Docker & Docker Compose
-   **API Specification:** OpenAPI 3.0 (Swagger)
-   **Database Migrations:** `node-pg-migrate`

---

## Getting Started

Follow these steps to get the complete backend running locally. The entire stack is containerized, so no local installation of Node.js or PostgreSQL is required.

### Prerequisites

-   [**Docker Desktop**](https://www.docker.com/products/docker-desktop/): Must be installed and running.
-   [**Git**](https://git-scm.com/): Required for cloning the repository.

### Step 1: Configuration

This project uses a single `.env` file at the root of the project to manage all configuration and secrets.

1.  **Clone the repository:**
    ```bash
    git clone <your-repository-url>
    cd webudget
    ```

2.  **Create your local `.env` file from the template:**
    ```bash
    cp .env.example .env
    ```

3.  **Edit the `.env` file** and fill in your secrets (Plaid keys, database password, etc.).

### Step 2: Launch & Verification

Once your `.env` file is configured, launch the entire backend stack with a single command. **Database migrations will run automatically on startup.**

1.  **Launch the application:**
    ```bash
    docker-compose up --build
    ```
    This command builds the Docker images and starts the API, Database, and Docs containers. The `-d` flag can be added to run in detached (background) mode.

2.  **Verify the services are running:**
    * **Health Check:** Open your browser and navigate to `http://localhost:3000/health`. You should see a `{"status":"OK",...}` response.
    * **API Docs:** Navigate to `http://localhost:8080` to see the interactive Swagger API documentation.

---

## Project Structure

This is a monorepo containing multiple packages:

-   `/server`: The Node.js backend API.
-   `/client`: The React frontend application (or other clients).
-   `/docs`: OpenAPI specifications and related documentation.

---

## API Documentation

Interactive API documentation is automatically generated and served by the `docs` service. You can access the live Swagger UI to view all endpoints and test them directly from your browser at:

-   **URL:** `http://localhost:8080`

---

## Advanced Operations

For detailed operational tasks such as connecting to the database, creating backups, and restoring data, please refer to the complete **[Deployment & Operations Guide](https://docs.google.com/document/d/1iUnlbMwTnSa1zSi8jWQZVOUL3rS9D93f6wgDG4iW0Qg/edit?tab=t.m0fxy3py2v37)**.

---

## Troubleshooting

**Problem: The API is not responding or in a crash loop.**

This is often caused by a misconfiguration in your `.env` file.

1.  Check the container logs for specific error messages:
    ```bash
    docker-compose logs -f api
    ```
2.  If you see `password authentication failed`, your `DATABASE_URL` is likely incorrect.
3.  To perform a clean reset, stop the containers and **delete the database volume**:
    ```bash
    # Warning: This command is destructive and will erase all data.
    docker-compose down -v
    ```
4.  Carefully check your `.env` file for typos, then restart the application:
    ```bash
    docker-compose up --build
    ```

##### components.json #####

{
    "$schema": "https://ui.shadcn.com/schema.json",
    "style": "new-york",
    "rsc": false,
    "tsx": true,
    "tailwind": {
      "config": "tailwind.config.ts",
      "css": "client/src/index.css",
      "baseColor": "neutral",
      "cssVariables": true,
      "prefix": ""
    },
    "aliases": {
      "components": "@/components",
      "utils": "@/lib/utils",
      "ui": "@/components/ui",
      "lib": "@/lib",
      "hooks": "@/hooks"
    }
}

##### docker-compose.yml #####

services:
  # --- Backend API Service ---
  api:
    build: ./server
    restart: unless-stopped
    env_file:
      - ./.env
    ports:
      - "3000:3000"
    depends_on:
      - db

  migrate:
    build:
      context: ./server
    image: webudget-api # Use the same image as the api service
    depends_on:
      - db # Ensure the database is ready before trying to run migrations
    env_file:
      - .env
    command: ["npm", "run", "migrate:up"]
  
  # --- PostgreSQL Database Service ---
  db:
    image: postgres:15-alpine
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
  
  # --- API Documentation Service ---
  docs:
    image: swaggerapi/swagger-ui:v5.17.14
    restart: unless-stopped
    env_file:
      - ./.env
    ports:
      - "8080:8080"
    environment:
      URL: /webudget_api_spec_v1.yaml
    volumes:
      - ./server/webudget_api_spec_v1.yaml:/usr/share/nginx/html/webudget_api_spec_v1.yaml

# --- Volumes Definition ---
volumes:
  postgres_data:

##### docs/Architecture Design Document.md #####

# **Architecture Design Document (ADD)**

### **V1.0**

Status: Approved  
Author: [Etienne Beaulac](mailto:etiennebeaulac@gmail.com)

### **1\. Introduction and Architectural Goals**

#### **1.1 Overview**

This document outlines the architecture for the WeBudget Minimum Viable Product (MVP). WeBudget is a personal finance management application designed to provide users with a consolidated view of their financial accounts. The MVP's primary function is to allow users to securely link their bank accounts via Plaid and view their aggregated account balances and transaction histories. This architecture is designed to serve as the foundation for a future cross-platform application suite (Web, iOS, Android).

#### **1.2 Architectural Drivers**

The design of the WeBudget backend is guided by the following key principles:

* **Low Cost:** The architecture must prioritize the use of open-source technologies and third-party services with robust free tiers to eliminate initial infrastructure costs during the bootstrapping phase.  
* **Scalability:** The system must be designed as a set of stateless components that can be scaled horizontally. This ensures the application can handle future user growth without requiring a fundamental redesign.  
* **Security:** As the system handles sensitive financial data, security is paramount. The architecture must incorporate industry-best practices for authentication, data transit, and storage to ensure user data is protected at all times.  
* **Maintainability:** The system will be divided into logical, decoupled components (frontend, backend API, database). This separation of concerns simplifies development, testing, and future updates.  
* **Cross-Platform Support:** The architecture centers on a unified REST API. This ensures that any client application—whether it's the initial React web app or future native mobile apps—can be built on top of a single, consistent backend.

### **2\. System Context Diagram**

This diagram provides a high-level overview of the WeBudget system and its interactions with users and external services.

* **Actors:**  
  * **Individual User:** The end-user of the WeBudget application.  
* **External Systems:**  
  * **Auth0:** Provides user authentication and identity management services.  
  * **Plaid:** Provides secure integration with financial institutions for data aggregation.

**Interactions:**

* The **Individual User** interacts with the **WeBudget System** via the client application.  
* The **WeBudget System** communicates with **Auth0** to authenticate and authorize users.  
* The **WeBudget System** communicates with **Plaid** to manage bank connections and retrieve financial data.

### **3\. Container Diagram**

This diagram zooms into the "WeBudget System" to show its major, independently deployable components.

* **Containers:**  
  1. **React Web Application:** A single-page application (SPA) that serves as the primary user interface for the MVP. It is responsible for all client-side rendering and logic.  
  2. **Node.js REST API:** The core of the backend. It handles synchronous business logic (e.g., handling user requests) and offloads long-running tasks to the Background Worker. This API is stateless.  
  3. **PostgreSQL Database:** The persistent data store for the application. It holds all application data and serves as a simple job queue for the MVP. *Note: This job queue implementation is a designed-for-replacement component, intended to be swapped with a dedicated service like RabbitMQ as load increases.*   
     * ***Note:** \*This job queue implementation is a designed-for-replacement component. The project will migrate to a dedicated service (e.g., RabbitMQ, AWS SQS) when monitoring reveals specific performance triggers, such as **job processing latency exceeding 60 seconds**, **a high rate of failures requiring complex retry logic**, or **database contention impacting API response times.***  
  4. **Background Worker:** A separate Node.js process responsible for handling asynchronous, long-running, and scheduled tasks.  
     * **Scalability:** Workers will use a transactional locking read (`SELECT ... FOR UPDATE SKIP LOCKED`) to ensure jobs are processed exactly once.  
     * **Retry Logic:** For failed transaction syncs, the worker will use an exponential backoff strategy (e.g., 1m, 5m, 15m). If a sync fails 4 consecutive times, it will be marked as `'ERROR'` and only re-attempted on the next scheduled 12-hour cycle.  
     * **UI Feedback Loop:** The final sync status of each Plaid Item (including `'ERROR'`) will be exposed via the API (e.g., in the `GET /accounts` response) to enable clear user feedback on the frontend.

Add diagram here

**Connections:**

* The **React Web App** makes secure HTTPS requests to the **Node.js REST API**.  
* The **Node.js REST API** reads from and writes to the **PostgreSQL Database**. It also adds jobs to a queue (represented by a table in the database) for the Background Worker.  
* The **Background Worker** polls the database for new jobs, executes them, and writes the results back to the database.  
* The **REST API** and **Background Worker** both make secure server-to-server API calls to **Auth0** and **Plaid**.

### **4\. Key Data Flow Diagram: Linking a New Bank Account (Asynchronous)**

This sequence illustrates the revised, asynchronous process for linking a bank account to prevent request timeouts and improve user experience.

1. **Client \-\> API (Request Link Token):** The user clicks "Add Account" in the **React Web App**. The app sends a POST /plaid/create\_link\_token request to the **Node.js API**, including the user's JWT.  
2. **API \-\> Plaid (Create Link Token):** The **Node.js API** validates the JWT and sends a link\_token/create request to the **Plaid API**.  
3. **Plaid \-\> API \-\> Client (Return Link Token):** Plaid returns a temporary link\_token, which the **Node.js API** forwards back to the **React Web App**.  
4. **Client \-\> Plaid (User Completes Plaid Link):** The **React Web App** uses the link\_token to initialize the Plaid Link UI. The user completes the flow, and Plaid returns a public\_token to the client.  
5. **Client \-\> API (Send Public Token):** The **React Web App** sends the public\_token to the **Node.js API** via a POST /plaid/exchange\_public\_token request.  
6. **API \-\> Plaid (Exchange for Access Token):** The **Node.js API** exchanges the public\_token with Plaid for a permanent access\_token and item\_id.  
7. **API \-\> Database (Store Securely):** The **Node.js API** encrypts the access\_token and saves the resulting ciphertext, item\_id, and other item details into the PlaidItems table in the **PostgreSQL Database**.  
8. **API \-\> Database (Queue Sync Job):** The **Node.js API** adds a new job to a dedicated jobs table in the database (e.g., {job\_type: 'INITIAL\_SYNC', item\_id: '...'} ).  
9. **API \-\> Client (Confirm Success):** The API immediately returns a 202 Accepted response to the **React Web App**, indicating the link was successful and that a background sync has begun. The UI can be updated to show the new institution in a "Syncing..." state.  
10. **Background Worker (Process Job):** The **Background Worker** process, polling the jobs table, picks up the INITIAL\_SYNC job. It decrypts the corresponding access\_token and performs the full data fetch from Plaid, populating the Accounts and Transactions tables. Upon completion, it updates the sync status of the Plaid Item in the database.

### **5\. Technology Stack Decisions**

| Component | Technology | Justification |
| :---- | :---- | :---- |
| **Frontend** | **React** | A modern, component-based library for building a dynamic and maintainable user interface. |
| **Backend API** | **Node.js \+ Express** | Excellent I/O performance for an API-heavy application. A vast ecosystem and official SDKs speed up development. |
| **Database** | **PostgreSQL** | A highly reliable relational database ideal for the structured and sensitive nature of financial data. |
| **Authentication** | **Auth0** | Offloads complex security implementation. Provides a robust, secure, and dedicated service with a generous free tier. |
| **Bank Integration** | **Plaid** | The industry standard for securely connecting to financial institutions. Its free developer tier is ideal for the MVP. |
| **Containerization** | **Docker** | Creates a consistent, portable, and isolated development environment that simplifies setup and deployment. |
| **DB Migrations** | **node-pg-migrate** | Enables version-controlled, automated, and repeatable database schema changes, crucial for maintainability. |
| **Dependency Security** | **npm audit \+ Snyk/Dependabot** | Implements a "supply chain" security strategy by actively scanning for and managing vulnerable third-party packages. |

### 

### **6\. Security, Serviceability & Best Practices**

#### **6.1 Authentication Flow**

Authentication is managed by Auth0, with the Node.js API setting a JWT in a **secure, `HttpOnly` cookie**. The cookie must be set with the `SameSite=Strict` or `SameSite=Lax` attribute to provide a strong, browser-level defense against Cross-Site Request Forgery (CSRF) attacks.

#### **6.2 API Authorization**

An Express middleware will validate the JWT from the cookie on every request. The user's unique ID (sub claim) from the token will be used in all database queries to enforce strict data-access policies.

#### **6.3 Data Security**

* **Encryption at Rest (Application-Level Encryption):** Plaid `access_tokens` will be encrypted in the application using **AES-256-GCM** before being stored in the database. The encryption key will be managed via **environment variables**.  
* **Key Management:** For the MVP, the master encryption key will be managed via **environment variables**.  
  * **Future Consideration:** Before the first public deployment, this key must be migrated to a dedicated secrets management service (e.g., HashiCorp Vault, AWS Secrets Manager) to adhere to production security standards.  
* **Encryption in Transit:** All communication between all components and services will use **HTTPS (TLS)**.

**6.4 Data Integrity & Handling**

* **Deletion Policy:** The `DELETE /institutions/{institutionId}` endpoint will perform a soft delete by setting an `archived_at` timestamp. All data retrieval queries must filter for records where `archived_at` is `NULL`. A background job will permanently delete these records and their associated data after 90 days.  
* **Transaction Atomicity:** When linking a new item, the database operations to (1) save the encrypted `access_token` and (2) queue the `INITIAL_SYNC` job **must be performed within a single database transaction** to prevent partial data states.  
* **User Data Preservation:** Transaction synchronization logic must be designed to be non-destructive to user-generated content. When transaction data is refreshed from Plaid, existing user-defined fields like `notes` and `userCategoryId` must be preserved.

#### **6.5 Operational Security**

* **Rate Limiting**: Specific limits will be enforced to prevent abuse  
  * **Global:** 100 requests/user/minute  
  * **Link Token Creation**: 5 requests/user/10 minutes  
  * **Manual Refresh**: 1 request/item/5 minutes  
* **Log Sanitization**: All logs must be scrubbed of PII and sensitive data. The mandatory scrub list includes: `user_id`, `email`, `full_name`, all Plaid tokens, `account_name`, `account_mask`, the raw Authorization header/JWT, `merchant_name`, and any address fields

#### **6.6 Serviceability**

* **Health Checks:** All backend containers will expose a `GET /health` endpoint to report their operational status and connectivity to dependencies.  
* **Configuration Management:** All operational variables (e.g., refresh intervals, lookback periods) will be managed via **environment variables**. Storing configuration in the database is out of scope for the MVP.  
* **Detailed Error Handling:** Plaid API errors will be categorized:  
  * **Actionable Errors (`ITEM_LOGIN_REQUIRED`):** The API will return a specific error code to the client, prompting the user to take action (e.g., "Reconnect your bank").  
  * **Transient Errors (`PRODUCT_NOT_READY`, `RATE_LIMIT_EXCEEDED`):** The API will log the detailed error for debugging but return a generic message to the client (e.g., "Could not connect to your bank. Please try again later.").


##### docs/Database Schema Document.md #####

[](./img/database_schema_diagram.png)

### **Guiding Principles**

This schema is designed with the following principles to ensure consistency, performance, and data integrity for a production-grade financial application.

1. **Naming Convention:** All database objects will use snake\_case.  
2. **Data Integrity:** We will use the most precise data types available (e.g., DECIMAL for money) and enforce relationships with foreign key constraints. We will use ENUM types where applicable to enforce state integrity at the database level.  
3. **Keys:** As a general rule, every table has a surrogate primary key named `id` of type `BIGSERIAL`. Exceptions are made where a stable, external natural key is more appropriate (e.g., the `users` table, which uses the ID from Auth0).  
4. **Timestamps:** All timestamp columns use TIMESTAMPTZ (timestamp with time zone).  
5. **Data Deletion Policy:**  
   * **Soft Deletes:** Key user-facing resources (users, plaid\_items) use an archived\_at column. This is the primary method for "deleting" data.  
   * **Operational Safety:** To prevent catastrophic accidental deletions, foreign key constraints will use ON DELETE RESTRICT instead of ON DELETE CASCADE. This forces the application logic to explicitly handle the deletion of child records before a parent can be hard-deleted, making it a deliberate, multi-step process.  
6. **Security:** Sensitive data is stored as encrypted binary data in a BYTEA column.

### **Custom Type Definitions (ENUMs)**

To align with Principle \#2 (Data Integrity), we define custom `ENUM` types for columns that have a fixed set of possible values. This enforces data consistency at the database level.

\`\`\`

\-- For the sync\_status column in the plaid\_items table

CREATE TYPE item\_status AS ENUM (

  'good',

  'syncing',

  'relink\_required',

  'error'

);

\-- For the status column in the background\_jobs table

CREATE TYPE job\_status AS ENUM (

  'queued',

  'running',

  'completed',

  'failed'

);

\-- For the type column in the accounts table, based on Plaid's official types

CREATE TYPE account\_type AS ENUM (

  'depository',

  'credit',

  'loan',

  'investment',

  'other'

);

\-- For the subtype column in the accounts table, based on Plaid's official subtypes

CREATE TYPE account\_subtype AS ENUM (

  'checking', 'savings', 'hsa', 'cd', 'money market', 'paypal', 'prepaid', 'credit card',

  'p2p', 'student', 'mortgage', 'home equity', 'line of credit', 'auto', 'business',

  'personal', '401a', '401k', '403b', '457b', '529', 'brokerage', 'cash isa',

  'education savings account', 'ebt', 'fixed annuity', 'gic', 'health reimbursement arrangement',

  'ira', 'isa', 'keogh', 'lif', 'life insurance', 'lira', 'lrif', 'lrsp',

  'non-taxable brokerage account', 'prif', 'rdsp', 'resp', 'rlif', 'rrif', 'rrsp',

  'sarsep', 'sep ira', 'simple ira', 'sipp', 'stock plan', 'thrift savings plan', 'tfsa',

  'trust', 'ugma', 'utma', 'variable annuity', 'pension', 'profit sharing plan',

  'retirement', 'roth', 'roth 401k', 'other'

);

\`\`\`

### **Table Definitions**

#### **1\. Table:** users

| Column Name | Data Type | Constraints & Notes |
| :---- | :---- | :---- |
| id | TEXT | **PRIMARY KEY**. The unique user ID from Auth0. |
| email | TEXT | NOT NULL, UNIQUE. |
| full\_name | TEXT | NULL. |
| profile\_image\_url | TEXT | NULL. |
| archived\_at | TIMESTAMPTZ | NULL. For soft-deleting users. |
| created\_at | TIMESTAMPTZ | NOT NULL, DEFAULT NOW(). |
| updated\_at | TIMESTAMPTZ | NOT NULL, DEFAULT NOW(). |

#### **2\. Table:** plaid\_items

| Column Name | Data Type | Constraints & Notes |
| :---- | :---- | :---- |
| id | BIGSERIAL | **PRIMARY KEY**. |
| user\_id | TEXT | NOT NULL. **FOREIGN KEY** \-\> users(id) ON DELETE RESTRICT. |
| plaid\_item\_id | TEXT | NOT NULL, UNIQUE. |
| plaid\_access\_token | BYTEA | NOT NULL. The encrypted Plaid access token. |
| plaid\_institution\_id | TEXT | NOT NULL. |
| institution\_name | TEXT | NOT NULL. |
| institution\_logo | TEXT | NULL. |
| sync\_status | item\_status | NOT NULL. **Uses an ENUM type** |
| last\_successful\_sync | TIMESTAMPTZ | NULL. |
| last\_sync\_error\_message | TEXT | NULL. |
| archived\_at | TIMESTAMPTZ | NULL. |
| created\_at | TIMESTAMPTZ | NOT NULL, DEFAULT NOW(). |
| updated\_at | TIMESTAMPTZ | NOT NULL, DEFAULT NOW(). |

#### **Indexes for `plaid_items`**

* An index will be created on the `user_id` column to optimize queries that filter items by user.

#### **3\. Table:** accounts

| Column Name | Data Type | Constraints & Notes |
| :---- | :---- | :---- |
| id | BIGSERIAL | **PRIMARY KEY**. |
| item\_id | BIGINT | NOT NULL. **FOREIGN KEY** \-\> plaid\_items(id) ON DELETE RESTRICT. |
| plaid\_account\_id | TEXT | NOT NULL, UNIQUE. |
| name | TEXT | NOT NULL. |
| mask | TEXT | NULL. |
| type | account\_type | NOT NULL. Uses the account\_type ENUM. |
| subtype | account\_subtype | NOT NULL. Uses the account\_subtype ENUM. |
| current\_balance | DECIMAL(28, 10\) | NOT NULL. |
| available\_balance | DECIMAL(28, 10\) | NULL. |
| credit\_limit | DECIMAL(28, 10\) | NULL. |
| currency\_code | TEXT | NULL. ISO 4217 code. |
| created\_at | TIMESTAMPTZ | NOT NULL, DEFAULT NOW(). |
| updated\_at | TIMESTAMPTZ | NOT NULL, DEFAULT NOW(). |

#### **Indexes for `accounts`**

* An index will be created on the `item_id` column to optimize queries that join or filter accounts by their parent institution.

#### **4\. Table:** transactions

| Column Name | Data Type | Constraints & Notes |
| :---- | :---- | :---- |
| id | BIGSERIAL | **PRIMARY KEY**. |
| account\_id | BIGINT | NOT NULL. **FOREIGN KEY** \-\> accounts(id) ON DELETE RESTRICT. |
| user\_category\_id | BIGINT | NULL. **FOREIGN KEY** \-\> user\_categories(id) ON DELETE SET NULL. |
| plaid\_transaction\_id | TEXT | NOT NULL. The transaction ID from Plaid. Uniqueness is enforced per account via a composite index. |
| amount | DECIMAL(28, 10\) | NOT NULL. |
| currency\_code | TEXT | NULL. |
| date | DATE | NOT NULL. **PARTITION KEY**. |
| merchant\_name | TEXT | NULL. |
| merchant\_logo | TEXT | NULL. |
| detailed\_category | TEXT | NULL. |
| is\_pending | BOOLEAN | NOT NULL, DEFAULT FALSE. |
| transaction\_type | TEXT | NULL. |
| payment\_channel | TEXT | NULL. |
| notes | TEXT | NULL. |
| created\_at | TIMESTAMPTZ | NOT NULL, DEFAULT NOW(). |
| updated\_at | TIMESTAMPTZ | NOT NULL, DEFAULT NOW(). |

Partitioning Strategy for transactions:

This table will be implemented as a Partitioned Table in PostgreSQL, using Range Partitioning on the date column.

* **Method:** A new child table will be created for each month of data (e.g., transactions\_2025\_06, transactions\_2025\_07).  
* **Benefit:** This keeps the most frequently accessed data (recent transactions) in smaller, more manageable tables, dramatically improving query performance, indexing, and maintenance operations. This is a highly scalable approach that prevents the table from becoming a bottleneck.

**Indexes and Constraints for `transactions`**

* **Uniqueness**: To enforce that a plaid\_transaction\_id is unique for each account\_id, a composite unique index will be created. Because this is a partitioned table, the partition key (date) must be part of the constraint: UNIQUE (account\_id, plaid\_transaction\_id, date).  
* **Foreign Key Performance**: An index will be created on the account\_id column to optimize queries filtering transactions by account. An additional index will be placed on user\_category\_id to speed up category-based lookups.

#### **5\. Table:** user\_categories

| Column Name | Data Type | Constraints & Notes |
| :---- | :---- | :---- |
| id | BIGSERIAL | **PRIMARY KEY**. |
| user\_id | TEXT | NOT NULL. **FOREIGN KEY** \-\> users(id) ON DELETE RESTRICT. |
| name | TEXT | NOT NULL. UNIQUE constraint on (user\_id, name). |
| created\_at | TIMESTAMPTZ | NOT NULL, DEFAULT NOW(). |
| updated\_at | TIMESTAMPTZ | NOT NULL, DEFAULT NOW(). |

#### **Indexes for `user_categories`**

* An index will be created on the `user_id` column to optimize category lookups for a specific user.

#### **6\. Table:** background\_jobs

| Column Name | Data Type | Constraints & Notes |
| :---- | :---- | :---- |
| id | BIGSERIAL | **PRIMARY KEY**. |
| job\_type | TEXT | NOT NULL. |
| payload | JSONB | NULL. |
| status | job\_status | NOT NULL, DEFAULT 'queued'. **Uses an ENUM type** |
| last\_attempt\_at | TIMESTAMPTZ | NULL. |
| last\_error | TEXT | NULL. |
| attempts | INTEGER | NOT NULL, DEFAULT 0. |
| created\_at | TIMESTAMPTZ | NOT NULL, DEFAULT NOW(). |

**Scaling Strategy for** background\_jobs**:**

* **Archival:** An automated process should periodically move old (\> 30 days) 'completed' and 'failed' jobs to an archived\_background\_jobs table to keep the primary queue lean.  
* **Performance Indexing:** A **partial index** (CREATE INDEX idx\_jobs\_pending ON background\_jobs (created\_at) WHERE status \= 'queued';) will be created to ensure worker polling queries are instant, regardless of the number of historical jobs in the table.

#### **7\. Table:** exchange\_rates 

**Scope Note:** This table and its associated logic are designed for future multi-currency support and are considered **Post-MVP**. Implementation will be prioritized based on user feedback and business needs after the initial launch.

| Column Name | Data Type | Constraints & Notes |
| :---- | :---- | :---- |
| date | DATE | **PRIMARY KEY**. |
| base\_currency | TEXT | **PRIMARY KEY**. The base for all conversions (e.g., 'USD'). |
| target\_currency | TEXT | **PRIMARY KEY**. The currency to convert to (e.g., 'CAD'). |
| rate | DECIMAL(18, 10\) | NOT NULL. The conversion rate. |
| updated\_at | TIMESTAMPTZ | NOT NULL, DEFAULT NOW(). |

**Usage Note for** exchange\_rates**:**

* This table will be populated daily by a scheduled background job that fetches rates from a reliable financial data provider (e.g., Open Exchange Rates). It allows for historically accurate aggregation of funds across different currencies in user reports.

### **Relationships Summary**

This section describes the foreign key relationships and their cardinality, which define how the tables are connected.

* **`users` `1` \--to-- `N` `plaid_items`**  
  * **Description:** A single User can link many financial institutions (Items).  
  * **Implementation:** The `plaid_items.user_id` column references `users.id`.  
* **`users` `1` \--to-- `N` `user_categories`**  
  * **Description:** A single User can create many of their own custom spending categories.  
  * **Implementation:** The `user_categories.user_id` column references `users.id`.  
* **`plaid_items` `1` \--to-- `N` `accounts`**  
  * **Description:** A single linked Institution (Item) can contain many individual accounts.  
  * **Implementation:** The `accounts.item_id` column references `plaid_items.id`.  
* **`accounts` `1` \--to-- `N` `transactions`**  
  * **Description:** A single Account has a history of many transactions.  
  * **Implementation:** The `transactions.account_id` column references `accounts.id`.  
* **`user_categories` `1` \--to-- `N` `transactions`**  
  * **Description:** A single user-defined Category can be applied to many different transactions, allowing users to override Plaid's default categorization.  
  * **Implementation:** The `transactions.user_category_id` column references `user_categories.id`.


##### docs/Deployment & Operations Guide.md #####

# **WeBudget: Deployment & Operations Guide (Local Docker Environment)**

**Version:** 1.0

**Last Updated:** June 18, 2025

## **1. Introduction & System Overview**

### **1.1 Purpose**

This document provides all necessary instructions to set up, configure, deploy, and operate the WeBudget backend application in a local development environment. Following this guide ensures a consistent and repeatable setup, which is foundational for stable development and testing.

This guide is intended for a local setup on a host machine (e.g., a Mac mini) and is **not suitable for a public production deployment**.

### **1.2 Architecture Reminder**

This guide will start three Docker containers using docker compose:

1. `api`: The Node.js/Express backend server.  
2. `db`: The PostgreSQL database for persistent data storage.  
3. `docs`: A SwaggerUI container to view live API documentation.

## **2. Prerequisites**

The following software must be installed and running on the host machine before proceeding.

* [x] **Docker Desktop for Mac:** The core containerization software. Ensure the Docker engine is running.  
* [x] **Git:** For cloning the source code repository from version control.  
* [x] **A Text Editor:** For creating and editing the .env configuration file (e.g., VS Code, Sublime Text).  
* [x] **(Recommended) A Database Client:** A tool like [DBeaver](https://dbeaver.io/) or the psql command-line tool for interacting with the database.

## **3. First-Time Setup**

This is a one-time process to get the project onto the host machine and configured for its first run.

### **Step 1: Clone the Repository**

Open a terminal and run the following command to download the source code:

```bash
git clone <your-repository-url>  
cd webudget
```

### **Step 2: Create the Environment Configuration File**

The application is configured using environment variables defined in a single `.env` file. This file must be created from the provided template.

**Security Note:** The `.env` file is used for secrets management. It is listed in the project's `.gitignore` file, which prevents you from ever accidentally committing sensitive credentials (API keys, passwords) to the codebase. This is a critical security best practice.

```bash
# In the project's root directory  
cp .env.example .env
```

Now, open the newly created `.env` file and populate it with the required values.

| Variable | Description | Example / Action to Take |
| :---- | :---- | :---- |
| `POSTGRES_USER` | The username for the PostgreSQL database. | Keep the default myuser from the example file. |
| `POSTGRES_PASSWORD` | The password for the PostgreSQL database. | **Set a secure password.** |
| `POSTGRES_DB` | The name of the database to create. | Keep the default webudget_db. |
| `DATABASE_URL` | The full connection string used by the API. **It must use the variables above.** | postgresql://myuser:mysecretpassword@db:5432/webudget_db |
| `PORT` | The port on which the Node.js API server will run inside the container. | Keep the default 3000. |
| `PLAID_CLIENT_ID` | Your client ID from the Plaid dashboard. | Get this from your [Plaid Dashboard](https://dashboard.plaid.com/team/keys). |
| `PLAID_SECRET` | Your secret key for the Plaid Sandbox environment. | Get this from your Plaid Dashboard. |
| `JWT_SECRET` | A long, random, secret string for signing JSON Web Tokens (JWTs). | **Generate a new secure secret.** |
| `ENCRYPTION_KEY` | **Critical:** A 64-character hex key (32 bytes) for AES-256 encryption of Plaid tokens in the DB. | **Generate a new secure key.** Use the command: openssl rand -hex 32 |

**Step 3: Database Migration and Application Launch**

 Database migrations are now managed separately from the application startup for safety and control. The process is now two distinct steps.

 **First, run database migrations:** Use the `migrate` service to apply any pending schema changes to the database.


```bash
# This command starts the db, runs migrations, and then exits.
docker compose run --rm migrate
```

 **Second, launch the application:** With the database schema up to date, start the main application services.


```bash
# Start the api, docs, and db containers in the background
docker compose up -d
```

 **Updating and Re-deploying**

 When you pull new code, the process remains separate: first migrate, then deploy.

```bash
# 1. Pull new code
git pull origin main

# 2. Run migrations in case the schema has changed
docker compose run --rm migrate

# 3. Rebuild the image and restart the application
docker compose up --build -d
```

 **Rolling Back a Migration (Advanced)**

 To revert the most recent database migration, you can explicitly run the `migrate:down` command:


```bash
docker compose run --rm migrate npm run migrate:down
```

### **Step 4: Verify Success**

Once the logs indicate the server has started, you can verify that everything is working correctly.

1. **Check the Health Endpoint:** Open your web browser and navigate to http://localhost:3000/health. This endpoint performs a deep health check to verify both server and database connectivity.  
    * A `200 OK` response with `{"status":"OK", ...}` indicates the API is running and can successfully communicate with the database.  
    * A `503 Service Unavailable` response indicates a problem with the database connection, which helps orchestrators correctly manage traffic.
2. **Check the API Docs:** Navigate to http://localhost:8080. The Swagger UI should load, displaying your API endpoints.

If both checks pass, the backend is fully set up and running.

## **4. Daily Operations**

### **Starting the Application**

To run the application in the background (detached mode):

```bash
docker compose up -d
```

*This will start the containers if they are stopped, or recreate them if they have changed, and leave them running in the background.*

### **Stopping the Application**

To safely shut down all running application containers:

```bash
docker compose down
```

**Warning:** To perform a full reset that **deletes the database**, use `docker compose down -v`. The `-v` flag is destructive and will permanently erase all data in your database volume. Only use this when you need a completely clean environment.

## **5. Common Operational Tasks**

### **Viewing Logs**

The application produces structured JSON logs for all operations, which is ideal for production monitoring systems. For local development, logs are automatically "pretty-printed" for readability.

To view the real-time logs from a running container:


```bash
# Follow the logs from the API server  
docker compose logs -f api  
# Follow the logs from the database  
docker compose logs -f db
```

Press `Ctrl+C` to stop viewing the logs.

### **Deploying Code Updates**

When new code is available from the Git repository, the deployment process is simple and reliable.

```bash
# 1. Pull the latest code changes  
git pull origin main  
  
# 2. Re-build the API image and restart the services  
# The automated migration will run on startup.  
docker compose up --build -d
```

### **Database Management**

#### **Connecting to the Database**

To get a direct psql shell inside the db container for manual inspection or queries:

```bash
docker compose exec db psql -U myuser -d webudget_db
```

*(Replace `myuser` and `webudget_db` if you changed them in your `.env` file.)*

#### **Creating a Database Backup**

To create a `.sql` backup of the entire database, run this command from the host machine. The backup file will be saved in your current directory.

```bash
# Syntax: docker compose exec -T <service_name> pg_dump -U <user> -d <db> > <backup_file.sql>  
docker compose exec -T db pg_dump -U myuser -d webudget_db > webudget_backup_$(date +%Y-%m-%d).sql
```

#### **Restoring from a Backup**

To restore the database from a `.sql` file, all existing data will be dropped and replaced.

```bash
# Syntax: cat <backup_file.sql> | docker compose exec -T <service_name> psql -U <user> -d <db>  
cat webudget_backup_2025-06-18.sql | docker compose exec -T db psql -U myuser -d webudget_db
```

### **Monitoring**

The application exposes critical performance metrics in a Prometheus-compatible format. This allows for monitoring application health, performance, and error rates.

#### **Accessing Metrics**

The metrics endpoint is available at `GET /metrics`. You can view the raw output using `curl`:

```bash
curl http://localhost:3000/metrics
```

## **6. Troubleshooting**

### **Problem: The API is not responding on** http://localhost:3000

1. Check that the containers are running with `docker compose ps`.  
2. If they are running, check for errors during startup with `docker compose logs api`. This is often caused by a misconfiguration in the `.env` file or a failed migration.

### **Problem: The** api **container exits immediately or is in a crash loop.**

1. This is most often a password authentication failed error or a failing migration script.  
2. It means the `DATABASE_URL` in your `.env` file does not match the `POSTGRES_` variables, or a migration is consistently failing.  
3. **Solution:**  
   * Stop the containers: `docker compose down`  
   * **Completely reset the database volume:** `docker compose down -v`  
   * Carefully verify all variables in your `.env` file are correct.  
   * Restart the application (`docker compose up --build`).

### **Problem: Plaid connection fails with an "invalid credentials" error.**

1. Run `docker compose logs -f api` to view the error response from Plaid.  
2. Double-check that the `PLAID_CLIENT_ID` and `PLAID_SECRET` in your `.env` file are copied correctly from your Plaid dashboard and do not contain extra spaces or characters.


##### docs/MVP System Requirements.md #####

# **System Requirements**

### **V1.1**

Status: Approved  
Author: [Etienne Beaulac](mailto:etiennebeaulac@gmail.com)

## **1.0 Overview**

This document outlines the functional and non-functional requirements for the backend system of the WeBudget MVP. The backend will serve as the central API for all client applications (web, iOS, Android) and will be responsible for user authentication, secure integration with the Plaid API, and management of financial data.

## **2.0 System Architecture & Core Components**

The backend system will consist of three primary components:

* **RESTful API:** The core application logic, exposing endpoints for clients to consume.  
* **Database:** A persistent data store for all user and financial information.  
* **External Integrations:** Secure services for handling authentication (Auth0) and financial data aggregation (Plaid).

## **3.0 Core Data Entities**

The system must store and manage the following data models.

* **User:** Represents an individual who has authenticated with the application.  
  * **Attributes:**  
    * Unique User ID (from Auth0)  
    * Email  
    * Full Name  
    * Profile Image URL (optional)  
* **Plaid Item (Linked Institution):** Represents a user's connection to a single financial institution via Plaid. A User can have many Plaid Items.  
  * **Attributes:**  
    * Plaid Item ID  
    * Plaid Access Token (must be stored securely with encryption)  
    * Institution Name (e.g., "Chase Bank")  
    * Institution Logo  
    * Sync Status (e.g., good, error, relink\_required)  
    * Last Successful Sync Timestamp  
    * Last Sync Error Message (optional)  
* **Account:** Represents a single bank account (e.g., checking, savings, credit card) belonging to a Plaid Item. A Plaid Item can have many Accounts.  
  * **Attributes:**  
    * Plaid Account ID  
    * Account Name (e.g., "Joint Checking")  
    * Account Mask (e.g., "0766")  
    * Account Type (e.g., depository, credit)  
    * Account Subtype (e.g., checking, savings)  
    * Current Balance  
    * Available Balance (if applicable)  
    * Credit Limit (for credit accounts)  
* **Transaction:** Represents a single financial transaction associated with an Account. An Account can have many Transactions.  
  * **Attributes:**  
    * Plaid Transaction ID  
    * Amount (positive for income, negative for expenses)  
    * Date (date the transaction was posted)  
    * Merchant Name (e.g., "Taco Bell")  
    * Merchant Logo  
    * Primary Category (from Plaid, e.g., "Food and Drink")  
    * Detailed Category (from Plaid, e.g., "Restaurants")  
    * Pending Status (boolean)  
    * Transaction Type (e.g., special, place, digital)  
    * Payment Channel (e.g., online, in store)  
    * Notes (text, optional, user-defined)  
    * User Category ID (optional, foreign key to a future Categories table, allows overriding Plaid's category)

## **4.0 Functional Requirements**

### **4.1 User Authentication & Authorization**

* **4.1.1** The system must use Auth0 for user authentication. All API endpoints must be protected and require a valid JSON Web Token (JWT) from Auth0.  
* **4.1.2** The backend must validate the JWT on every request to identify the user and authorize access to their specific data only. A user must never be able to access another user's data.

### **4.2 Plaid Integration: Account Linking & Data Syncing**

* **4.2.1** The backend must provide an endpoint that generates and returns a link\_token for the frontend to initialize the Plaid Link module.  
* **4.2.2** The backend must provide an endpoint to receive a public\_token from the frontend, exchange it with Plaid for an access\_token and item\_id, and securely store this information.  
* **4.2.3** Upon linking a new Item, the system must perform an initial pull of that Item's Accounts and Transactions. The default lookback period for this initial transaction sync will be 30 days. This value must be stored in a configurable variable to be easily changed in the future.  
* **4.2.4** The system must handle ongoing transaction updates through two methods:  
  * **4.2.4.1** (Automatic Refresh): A background process must attempt to sync transactions for each valid Plaid Item on a periodic basis (e.g., every 12 hours). The refresh interval must be a configurable variable.  
  * **4.2.4.2** (Manual Refresh): The backend must provide an endpoint (POST /items/{item\_id}/refresh) to allow the user to trigger an immediate data sync for a specific institution.  
* **4.2.5** The system must gracefully handle ITEM\_LOGIN\_REQUIRED errors from Plaid. It must update the Plaid Item's Sync Status to 'relink\_required' and provide this status via the API so the frontend can prompt the user to re-authenticate the item.  
* **4.2.6** When the system syncs new or updated transaction data from Plaid, it must preserve any existing user-defined data on those transactions (e.g., `Notes`, `UserCategoryId`). The sync process must only update fields that originate from Plaid.

### **4.3 Accounts API Endpoints**

* **4.3.1** The backend must provide an endpoint (GET /accounts) that returns a list of all Accounts for the authenticated user.  
* **4.3.2** The data must be structured by institution (Plaid Item), matching the grouping shown in the UI mockups.  
* **4.3.3** The backend must provide an endpoint (DELETE /items/{item\_id}) soft delete to remove a linked institution and all of its associated accounts and transactions.

### **4.4 Transactions API Endpoints**

* **4.4.1** The backend must provide an endpoint (GET /transactions) that returns a list of all Transactions for the authenticated user, sorted by date descending.  
* **4.4.2** The endpoint must support pagination to handle large numbers of transactions efficiently.  
* **4.4.3** The endpoint must support filtering by Account, startDate, endDate, and a searchText query parameter to enable the functionality shown in the UI mockups.  
* **4.4.4** The system must be able to identify transactions that are transfers between a user's linked accounts. For the MVP, this will be achieved by filtering for transactions with Plaid's 'Transfer' category. This endpoint should be filterable (`GET /transactions?category=transfer`). **Note: This method is a baseline for the MVP and may not identify all internal transfers with 100% accuracy. A more robust heuristic-based matching system is planned for a future release.**

## **5.0 Non-Functional Requirements**

* **5.1 Security:** All sensitive data, especially Plaid access\_tokens, must be encrypted at rest in the database.  
* **5.2 Scalability:** The API should be designed to be stateless, allowing for horizontal scaling by running multiple instances of the application.  
* **5.3 Data Integrity:** The system must ensure that operations that involve multiple steps (e.g., linking a new item and fetching its accounts) are atomic to prevent partial data states.  
* **5.4 Error Handling:** The API must provide clear and consistent error messages to the client applications when a request fails.  
* **5.5 Performance:** The API should have a median response time of under 500ms for all read operations (GET requests) under normal load.  
* **5.6 Logging:** The system must log all critical errors and API requests/responses (without sensitive data) to a centralized logging service to facilitate debugging and monitoring.  
* **5.7 Backup & Recovery:** The database must be automatically backed up on a daily basis, with the ability to perform a point-in-time recovery to any point in the last 7 days.  
* **5.8 Data Retention**  
  * **5.8.1** When a user archives a linked institution (`Plaid Item`), the system will perform a soft delete.  
  * **5.8.2** The system must implement a scheduled background process that automatically hard-deletes any soft-deleted `Plaid Item` and all its associated `Accounts` and `Transactions` after a retention period of **90 days**.

##### drizzle.config.ts #####

import { defineConfig } from "drizzle-kit";

if (!process.env.DATABASE_URL) {
  throw new Error("DATABASE_URL, ensure the database is provisioned");
}

export default defineConfig({
  out: "./migrations",
  schema: "./shared/schema.ts",
  dialect: "postgresql",
  dbCredentials: {
    url: process.env.DATABASE_URL,
  },
});


##### package.json #####

{
  "name": "rest-express",
  "version": "1.0.0",
  "type": "module",
  "license": "MIT",
  "scripts": {
    "dev": "NODE_ENV=development tsx server/index.ts",
    "build": "vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist",
    "start": "NODE_ENV=production node dist/index.js",
    "check": "tsc",
    "db:push": "drizzle-kit push",
    "postinstall": "flowbite-react patch"
  },
  "dependencies": {
    "@hookform/resolvers": "^3.10.0",
    "@jridgewell/trace-mapping": "^0.3.25",
    "@neondatabase/serverless": "^0.10.4",
    "@radix-ui/react-accordion": "^1.2.4",
    "@radix-ui/react-alert-dialog": "^1.1.7",
    "@radix-ui/react-aspect-ratio": "^1.1.3",
    "@radix-ui/react-avatar": "^1.1.4",
    "@radix-ui/react-checkbox": "^1.1.5",
    "@radix-ui/react-collapsible": "^1.1.4",
    "@radix-ui/react-context-menu": "^2.2.7",
    "@radix-ui/react-dialog": "^1.1.7",
    "@radix-ui/react-dropdown-menu": "^2.1.7",
    "@radix-ui/react-hover-card": "^1.1.7",
    "@radix-ui/react-label": "^2.1.3",
    "@radix-ui/react-menubar": "^1.1.7",
    "@radix-ui/react-navigation-menu": "^1.2.6",
    "@radix-ui/react-popover": "^1.1.7",
    "@radix-ui/react-progress": "^1.1.3",
    "@radix-ui/react-radio-group": "^1.2.4",
    "@radix-ui/react-scroll-area": "^1.2.4",
    "@radix-ui/react-select": "^2.1.7",
    "@radix-ui/react-separator": "^1.1.3",
    "@radix-ui/react-slider": "^1.2.4",
    "@radix-ui/react-slot": "^1.2.0",
    "@radix-ui/react-switch": "^1.1.4",
    "@radix-ui/react-tabs": "^1.1.4",
    "@radix-ui/react-toast": "^1.2.7",
    "@radix-ui/react-toggle": "^1.1.3",
    "@radix-ui/react-toggle-group": "^1.1.3",
    "@radix-ui/react-tooltip": "^1.2.0",
    "@tanstack/react-query": "^5.60.5",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cmdk": "^1.1.1",
    "connect-pg-simple": "^10.0.0",
    "date-fns": "^3.6.0",
    "dotenv": "^16.5.0",
    "drizzle-orm": "^0.39.1",
    "drizzle-zod": "^0.7.0",
    "embla-carousel-react": "^8.6.0",
    "express": "^4.21.2",
    "express-session": "^1.18.1",
    "flowbite": "^3.1.2",
    "flowbite-react": "^0.11.7",
    "framer-motion": "^11.13.1",
    "input-otp": "^1.4.2",
    "lucide-react": "^0.453.0",
    "material-icons": "^1.13.14",
    "memorystore": "^1.6.7",
    "next-themes": "^0.4.6",
    "passport": "^0.7.0",
    "passport-local": "^1.0.0",
    "plaid": "^33.0.0",
    "react": "^18.3.1",
    "react-day-picker": "^8.10.1",
    "react-dom": "^18.3.1",
    "react-hook-form": "^7.55.0",
    "react-icons": "^5.4.0",
    "react-resizable-panels": "^2.1.7",
    "recharts": "^2.15.2",
    "tailwind-merge": "^2.6.0",
    "tailwindcss-animate": "^1.0.7",
    "tw-animate-css": "^1.2.5",
    "vaul": "^1.1.2",
    "wouter": "^3.3.5",
    "ws": "^8.18.0",
    "zod": "^3.24.2",
    "zod-validation-error": "^3.4.0"
  },
  "devDependencies": {
    "@replit/vite-plugin-cartographer": "^0.2.0",
    "@replit/vite-plugin-runtime-error-modal": "^0.0.3",
    "@tailwindcss/typography": "^0.5.15",
    "@tailwindcss/vite": "^4.1.3",
    "@types/connect-pg-simple": "^7.0.3",
    "@types/express": "4.17.21",
    "@types/express-session": "^1.18.0",
    "@types/node": "20.16.11",
    "@types/passport": "^1.0.16",
    "@types/passport-local": "^1.0.38",
    "@types/react": "^18.3.11",
    "@types/react-dom": "^18.3.1",
    "@types/ws": "^8.5.13",
    "@vitejs/plugin-react": "^4.3.2",
    "autoprefixer": "^10.4.20",
    "drizzle-kit": "^0.30.4",
    "esbuild": "^0.25.0",
    "postcss": "^8.4.47",
    "tailwindcss": "^3.4.17",
    "tsx": "^4.19.1",
    "typescript": "5.6.3",
    "vite": "^5.4.14"
  },
  "optionalDependencies": {
    "bufferutil": "^4.0.8"
  }
}


##### postcss.config.js #####

export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}


##### server/.dockerignore #####

# Git files
.git
.gitignore

# Local environment variables
.env*

# Node dependencies (we install these inside the container)
node_modules

# Compiled output (we create this inside the container)
dist

# Logs
npm-debug.log*

##### server/.gitignore #####

# Environment variables
.env

# Node modules
node_modules

# Compiled TypeScript output
dist

##### server/Dockerfile #####

# ---- Stage 1: Build ----
# This stage installs dependencies and builds the TypeScript code

# Use an official Node.js image. Alpine versions are smaller.
FROM node:18-alpine AS builder

# Set the working directory inside the container
WORKDIR /usr/src/app

# Copy package.json and package-lock.json first to leverage Docker caching
COPY package*.json ./

# Install all dependencies, including devDependencies for building
RUN npm install

# Copy the rest of the application's source code
COPY . .

# Compile TypeScript to JavaScript
RUN npm run build


# ---- Stage 2: Production ----
# This stage creates the final, lean image with only what's needed to run

FROM node:18-alpine

WORKDIR /usr/src/app

# Copy package files again
COPY package*.json ./

# Install ONLY production dependencies (and node-pg-migrate)
RUN npm install --only=production

# Copy the compiled code from the 'builder' stage
COPY --from=builder /usr/src/app/dist ./dist

# Copy the top-level migrations folder
COPY --from=builder /usr/src/app/migrations ./migrations

# Copy the entrypoint script into the container's filesystem
COPY entrypoint.sh .

# Make the script executable
RUN chmod +x ./entrypoint.sh

# Expose the port the app runs on
EXPOSE 3000

# 3. Set the entrypoint script as the container's entrypoint
ENTRYPOINT ["./entrypoint.sh"]

# 4. Set the default command to be passed to the entrypoint
CMD [ "node", "dist/index.js" ]

##### server/entrypoint.sh #####

#!/bin/sh
# Exit immediately if a command exits with a non-zero status.
set -e

# This is the crucial part. 'exec "$@"' replaces the shell script
# with the command that was passed as arguments to the script
# (e.g., `node dist/index.js`). This ensures the Node server
# becomes the main process (PID 1) in the container.
echo "Starting server..."
exec "$@"

##### server/migrate-pg-config.js #####

require('dotenv').config({ path: '../.env' });

module.exports = {
  connectionString: process.env.DATABASE_URL,
  
  dir: 'migrations',
  
  direction: 'up',
  count: Infinity,
  dbClient: 'pg',
  
  migration_table: 'pgmigrations',
};


##### server/migrations/1750195973683_create-initial-schema.js #####

/* eslint-disable @typescript-eslint/naming-convention */

exports.shorthands = undefined;

/**
 * @param {import("node-pg-migrate/dist/types").MigrationBuilder} pgm
 */
exports.up = (pgm) => {
  // 1. Create users table
  pgm.createTable('users', {
    id: {
      type: 'VARCHAR(255)',
      primaryKey: true,
      comment: 'The unique user ID from Auth0 (sub claim)',
    },
    email: {
      type: 'VARCHAR(255)',
      notNull: true,
      unique: true,
    },
    full_name: {
      type: 'VARCHAR(255)',
      notNull: true,
    },
    created_at: {
      type: 'TIMESTAMP WITH TIME ZONE',
      notNull: true,
      default: pgm.func('current_timestamp'),
    },
    updated_at: {
      type: 'TIMESTAMP WITH TIME ZONE',
      notNull: true,
      default: pgm.func('current_timestamp'),
    },
  });

  // 2. Create plaid_items table
  pgm.createTable('plaid_items', {
    id: {
      type: 'SERIAL',
      primaryKey: true,
    },
    user_id: {
      type: 'VARCHAR(255)',
      notNull: true,
      references: 'users(id)',
      onDelete: 'CASCADE',
    },
    plaid_item_id: {
      type: 'VARCHAR(255)',
      notNull: true,
      unique: true,
    },
    plaid_access_token: {
      type: 'TEXT',
      notNull: true,
      comment: 'This will be stored encrypted at the application level',
    },
    plaid_institution_id: {
      type: 'VARCHAR(255)',
      notNull: true,
    },
    institution_name: {
        type: 'VARCHAR(255)',
        notNull: true,
    },
    sync_status: {
      type: 'VARCHAR(50)',
      notNull: true,
      default: 'good', // 'good', 'syncing', 'relink_required', 'error'
    },
    last_successful_sync: {
      type: 'TIMESTAMP WITH TIME ZONE',
    },
    created_at: {
      type: 'TIMESTAMP WITH TIME ZONE',
      notNull: true,
      default: pgm.func('current_timestamp'),
    },
    updated_at: {
      type: 'TIMESTAMP WITH TIME ZONE',
      notNull: true,
      default: pgm.func('current_timestamp'),
    },
  });
  // Add an index on the foreign key for performance
  pgm.createIndex('plaid_items', 'user_id');

  // 3. Create accounts table
  pgm.createTable('accounts', {
    id: {
      type: 'SERIAL',
      primaryKey: true,
    },
    item_id: {
      type: 'INTEGER',
      notNull: true,
      references: 'plaid_items(id)',
      onDelete: 'CASCADE',
    },
    plaid_account_id: {
      type: 'VARCHAR(255)',
      notNull: true,
      unique: true,
    },
    name: {
      type: 'VARCHAR(255)',
      notNull: true,
    },
    mask: {
      type: 'VARCHAR(10)',
    },
    type: {
      type: 'VARCHAR(100)',
      notNull: true,
    },
    subtype: {
      type: 'VARCHAR(100)',
      notNull: true,
    },
    current_balance: {
      type: 'NUMERIC(28, 10)',
      notNull: true,
    },
    available_balance: {
      type: 'NUMERIC(28, 10)',
    },
    currency_code: {
      type: 'VARCHAR(10)',
    },
    created_at: {
      type: 'TIMESTAMP WITH TIME ZONE',
      notNull: true,
      default: pgm.func('current_timestamp'),
    },
    updated_at: {
      type: 'TIMESTAMP WITH TIME ZONE',
      notNull: true,
      default: pgm.func('current_timestamp'),
    },
  });
  pgm.createIndex('accounts', 'item_id');

  // 4. Create transactions table
  pgm.createTable('transactions', {
    id: {
      type: 'SERIAL',
      primaryKey: true,
    },
    account_id: {
      type: 'INTEGER',
      notNull: true,
      references: 'accounts(id)',
      onDelete: 'CASCADE',
    },
    plaid_transaction_id: {
      type: 'VARCHAR(255)',
      notNull: true,
      unique: true,
    },
    amount: {
      type: 'NUMERIC(28, 10)',
      notNull: true,
    },
    currency_code: {
      type: 'VARCHAR(10)',
    },
    date: {
      type: 'DATE',
      notNull: true,
    },
    merchant_name: {
      type: 'TEXT',
    },
    primary_category: {
      type: 'VARCHAR(255)',
    },
    is_pending: {
      type: 'BOOLEAN',
      notNull: true,
      default: false,
    },
    created_at: {
      type: 'TIMESTAMP WITH TIME ZONE',
      notNull: true,
      default: pgm.func('current_timestamp'),
    },
    updated_at: {
      type: 'TIMESTAMP WITH TIME ZONE',
      notNull: true,
      default: pgm.func('current_timestamp'),
    },
  });
  pgm.createIndex('transactions', 'account_id');
  pgm.createIndex('transactions', 'date'); // Indexing by date is common for filtering
};

/**
 * @param {import("node-pg-migrate/dist/types").MigrationBuilder} pgm
 */
exports.down = (pgm) => {
  // Drop tables in the reverse order of creation due to foreign key constraints
  pgm.dropTable('transactions');
  pgm.dropTable('accounts');
  pgm.dropTable('plaid_items');
  pgm.dropTable('users');
};

##### server/package.json #####

{
  "name": "server",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "build": "tsc",
    "start": "node dist/index.js",
    "dev": "nodemon src/index.ts",
    "migrate:make": "node-pg-migrate create",
    "migrate:up": "node-pg-migrate up",
    "migrate:down": "node-pg-migrate down"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "type": "commonjs",
  "dependencies": {
    "cors": "^2.8.5",
    "dotenv": "^16.5.0",
    "express": "^5.1.0",
    "node-pg-migrate": "^8.0.2",
    "pg": "^8.16.0",
    "prom-client": "^15.1.0",
    "pino": "^8.21.0",
    "pino-http": "^9.0.0",
    "pino-pretty": "^11.0.0"
  },
  "devDependencies": {
    "@types/cors": "^2.8.19",
    "@types/express": "^5.0.3",
    "@types/pg": "^8.15.4",
    "nodemon": "^3.1.10",
    "ts-node": "^10.9.2",
    "typescript": "^5.8.3"
  }
}

##### server/src/api/routes/index.ts #####

// src/api/routes/index.ts
import { Router, Request, Response } from 'express';

const router = Router();

// Test route for the V1 API
router.get('/', (req: Request, res: Response) => {
    res.status(200).json({ message: 'Welcome to the WeBudget API v1' });
});

// We will import other route files here later
// e.g., router.use('/plaid', plaidRoutes);

export default router;

##### server/src/config/database.ts #####

// src/config/database.ts
import { Pool } from 'pg';
import dotenv from 'dotenv';

dotenv.config();

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
});

export default pool;

##### server/src/index.ts #####

// src/index.ts
import express, { Express, Request, Response } from 'express';
import dotenv from 'dotenv';
import cors from 'cors';
import apiV1Router from './api/routes';
import pool from './config/database';
import { httpRequestDurationSeconds, httpRequestsTotal } from './metrics';
import register from './metrics';
import logger from './logger';
import pinoHttp from 'pino-http';
import { randomUUID } from 'crypto';

// Load environment variables from .env file
dotenv.config();

// Initialize the Express application
const app: Express = express();
const port = process.env.PORT || 3000;

app.use(pinoHttp({
  logger,
  // Define a custom request ID header
  genReqId: function (req, res) {
    const existingId = req.id ?? req.headers["x-request-id"];
    if (existingId) return existingId;
    const id = randomUUID();
    res.setHeader('X-Request-Id', id);
    return id;
  },
}));

// --- Global Middleware ---
// Enable Cross-Origin Resource Sharing
app.use(cors());
// Enable JSON body parsing
app.use(express.json());

app.use((req, res, next) => {
  const end = httpRequestDurationSeconds.startTimer();

  res.on('finish', () => {
    const route = req.route ? req.route.path : req.originalUrl.split('?')[0];

    const labels = {
      method: req.method,
      route: route,
      code: res.statusCode.toString()
    };

    end(labels); // Record the duration
    httpRequestsTotal.inc(labels); // Increment the counter
  });

  next();
});

// --- Health Check Endpoint ---
app.get('/health', async (req: Request, res: Response) => {
  const healthCheck = {
    status: 'OK',
    timestamp: new Date().toISOString(),
    dependencies: {
      database: 'OK',
    },
  };

  try {
    // The 'pg' library's pool.query method is efficient.
    // It will check out a client, run the query, and release it automatically.
    await pool.query('SELECT 1');
    req.log.info('Health check successful');
    res.status(200).json(healthCheck);
  } catch (error) {
    // Log the actual error for debugging
    req.log.error({ err: error }, 'Health check failed due to database error.');

    healthCheck.status = 'UNAVAILABLE';
    healthCheck.dependencies.database = 'UNAVAILABLE';
    res.status(503).json(healthCheck);
  }
});

app.get('/metrics', async (req: Request, res: Response) => {
  res.set('Content-Type', register.contentType);
  res.end(await register.metrics());
});

app.use('/api/v1', apiV1Router);

// --- Start the Server ---
app.listen(port, () => {
  logger.info(`[server]: Server is running at http://localhost:${port}`);
});

##### server/src/logger.ts #####

// src/logger.ts
import pino from 'pino';

// Define the paths to redact from logs, based on the Architecture Design Document.
// This is a security best practice to prevent leaking PII.
const redactPaths = [
    'req.headers.authorization',
    'user.email',
    'user.full_name',
    'user.id', // Equivalent to user_id
    '*.user_id',
    '*.plaid_access_token',
    '*.account_name',
    '*.account_mask',
    '*.merchant_name',
    'body.email',
    'body.password', // Always redact passwords
];

const logger = pino({
    level: process.env.LOG_LEVEL || 'info',
    transport: process.env.NODE_ENV !== 'production' ? {
      target: 'pino-pretty',
      options: {
        colorize: true
      }
    } : undefined,
    redact: {
        paths: redactPaths,
        censor: '[REDACTED]',
    },
});

export default logger;

##### server/src/metrics.ts #####

// src/metrics.ts
import client from 'prom-client';

// Create a Registry to register the metrics
const register = new client.Registry();

// Add a default label (service_name) to all metrics
register.setDefaultLabels({
    service_name: 'webudget-api'
});

// Enable default metrics collection (memory, CPU, etc.)
client.collectDefaultMetrics({ register });

// Create a histogram to measure HTTP request durations in seconds
export const httpRequestDurationSeconds = new client.Histogram({
    name: 'http_request_duration_seconds',
    help: 'Duration of HTTP requests in seconds',
    labelNames: ['method', 'route', 'code'],
    buckets: [0.1, 0.3, 0.5, 0.7, 1, 3, 5, 7, 10], // Buckets in seconds
});
register.registerMetric(httpRequestDurationSeconds); // Register the histogram

// Create a counter for total HTTP requests
export const httpRequestsTotal = new client.Counter({
    name: 'http_requests_total',
    help: 'Total number of HTTP requests',
    labelNames: ['method', 'route', 'code']
});
register.registerMetric(httpRequestsTotal); // Register the counter

export default register;

##### server/tsconfig.json #####

{
  "compilerOptions": {
    "target": "es2022", /* Set the JavaScript language version for emitted JavaScript. */
    "module": "commonjs", /* Specify what module code is generated. */
    "rootDir": "./src", /* Specify the root folder within your source files. */
    "outDir": "./dist", /* Specify an output folder for all emitted files. */
    "esModuleInterop": true, /* Emit additional JavaScript to ease support for CommonJS modules. */
    "forceConsistentCasingInFileNames": true, /* Ensure that casing is correct in imports. */
    "strict": true, /* Enable all strict type-checking options. */
    "skipLibCheck": true /* Skip type checking all .d.ts files. */
  },
  "include": [
    "src/**/*"
  ] /* Include all files in the src directory for compilation */
}

##### server/webudget_api_spec_v1.yaml #####

# WeBudget API Specification v1.1.0
# This document defines the RESTful API for the WeBudget MVP.
# It follows the OpenAPI 3.0 standard.

openapi: 3.0.3
info:
  title: "WeBudget API"
  description: |-
    The official API specification for the WeBudget personal finance management application.
    This API is used by all WeBudget clients (Web, iOS, Android) to interact with user financial data.

    Core Principles:
    - **Versioning:** URL Path Versioning (/api/v1)
    - **Authentication:** JWT via HttpOnly Cookie (and Authorization header for non-web clients)
    - **Data Format:** JSON with camelCase keys
    - **Dates:** ISO 8601 format (YYYY-MM-DDTHH:mm:ss.sssZ)
    - **Error Handling:** Standardized JSON error body
    - **Pagination:** Offset/Limit strategy
  version: "1.1.0"
  contact:
    name: "Backend Team"
    email: "etiennebeaulac@gmail.com"

servers:
  - url: http://localhost:3000/api/v1
    description: Local development server
  - url: https://api.webudget.app/api/v1
    description: Production server (Future)

security:
  - bearerAuth: []

tags:
  - name: Plaid
    description: Endpoints for integrating with the Plaid API.
  - name: Institutions
    description: Endpoints for managing and retrieving linked financial institutions.
  - name: Transactions
    description: Endpoints for retrieving transactions.
  - name: Health
    description: Application health check.

# ===============================================================================
# PATHS - The core endpoint definitions for the API.
# ===============================================================================
paths:
  # --- Plaid Integration ---
  /plaid/create-link-token:
    post:
      tags:
        - Plaid
      summary: Create Plaid Link Token
      description: |-
        Generates a short-lived `link_token` required to initialize the Plaid Link frontend component.
      operationId: createLinkToken
      responses:
        "200":
          description: Successfully created the link token.
          content:
            application/json:
              schema:
                type: object
                properties:
                  linkToken:
                    type: string
                    example: "link-sandbox-c8b1b0a7-a37e-405a-8b89-9b993302758f"
                  expiration:
                    type: string
                    format: date-time
                    example: "2025-06-17T20:34:25.000Z"
        "401":
          $ref: '#/components/responses/Unauthorized'
        "429":
          $ref: '#/components/responses/TooManyRequests'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /plaid/exchange-public-token:
    post:
      tags:
        - Plaid
      summary: Exchange Public Token
      description: |-
        Exchanges a `public_token` for a permanent `access_token` and creates a new Institution resource.
        This endpoint queues a background job for the initial data sync and immediately returns a `202 Accepted`.
      operationId: exchangePublicToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - publicToken
              properties:
                publicToken:
                  type: string
                  description: The public token from the Plaid Link success callback.
      responses:
        "202":
          description: |-
            Accepted. The token exchange was successful and the initial data sync has been queued.
            The response body contains the newly created Institution resource with a `syncStatus` of `syncing`.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Institution'
        "400":
          $ref: '#/components/responses/BadRequest'
        "401":
          $ref: '#/components/responses/Unauthorized'
        "500":
          $ref: '#/components/responses/InternalServerError'

  # --- Institutions ---
  /institutions:
    get:
      tags:
        - Institutions
      summary: Get All Institutions and their Accounts
      description: |-
        Returns a paginated list of all financial institutions for the authenticated user, with their nested accounts.
      operationId: getInstitutions
      parameters:
        - name: limit
          in: query
          description: The number of institutions to return.
          schema:
            type: integer
            default: 25
            maximum: 100
        - name: offset
          in: query
          description: The number of institutions to skip for pagination.
          schema:
            type: integer
            default: 0
      responses:
        "200":
          description: A paginated list of the user's institutions, each containing their accounts.
          content:
            application/json:
              schema:
                type: object
                properties:
                  pagination:
                    $ref: '#/components/schemas/Pagination'
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/InstitutionWithAccounts'
        "401":
          $ref: '#/components/responses/Unauthorized'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /institutions/{institutionId}:
    delete:
      tags:
        - Institutions
      summary: Archive Linked Institution
      description: |-
        Archives a connection to a financial institution. This performs a soft delete.
        All associated accounts and transactions will be hidden from the user but preserved in the system.
      operationId: deleteInstitution
      parameters:
        - $ref: '#/components/parameters/InstitutionId'
      responses:
        "200":
          description: The institution was successfully archived. The response body contains the updated resource.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Institution'
        "401":
          $ref: '#/components/responses/Unauthorized'
        "403":
          $ref: '#/components/responses/Forbidden'
        "404":
          $ref: '#/components/responses/NotFound'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /institutions/{institutionId}/refresh:
    post:
      tags:
        - Institutions
      summary: Trigger Manual Data Refresh
      description: |-
        Triggers an immediate, asynchronous data refresh for a specific institution.
        The API will respond with `202 Accepted` and queue a background job to sync transactions.
      operationId: refreshInstitution
      parameters:
        - $ref: '#/components/parameters/InstitutionId'
      responses:
        "202":
          description: |-
            Accepted. The data refresh has been successfully queued.
            The response body contains the institution resource with its `syncStatus` updated to `syncing`.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Institution'
        "401":
          $ref: '#/components/responses/Unauthorized'
        "403":
          $ref: '#/components/responses/Forbidden'
        "404":
          $ref: '#/components/responses/NotFound'
        "429":
          $ref: '#/components/responses/TooManyRequests'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /institutions/{institutionId}/relink-token:
    post:
      tags:
        - Institutions
      summary: Create Relink Token
      description: |-
        Creates a new `link_token` for an existing Institution that is in an error state (e.g., `relink_required`).
        This token is used to initialize Plaid Link in "update mode," allowing the user to re-authenticate their credentials
        and fix the connection.
      operationId: createRelinkToken
      parameters:
        - $ref: '#/components/parameters/InstitutionId'
      responses:
        "200":
          description: Successfully created the link token for update mode.
          content:
            application/json:
              schema:
                type: object
                properties:
                  linkToken:
                    type: string
                    example: "link-sandbox-c8b1b0a7-a37e-405a-8b89-9b993302758f"
                  expiration:
                    type: string
                    format: date-time
                    example: "2025-06-18T14:05:00.000Z"
        "401":
          $ref: '#/components/responses/Unauthorized'
        "403":
          $ref: '#/components/responses/Forbidden'
        "404":
          $ref: '#/components/responses/NotFound'
        "409": 
          description: The institution is not in a state that requires relinking.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiError'
        "500":
          $ref: '#/components/responses/InternalServerError'

  # --- Transactions ---
  /transactions:
    get:
      tags:
        - Transactions
      summary: List All Transactions
      description: |-
        Returns a paginated list of all transactions for the authenticated user from all linked accounts.
        Supports filtering by date range, account(s), category, and search query.
      operationId: getTransactions
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 25
            maximum: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
        - name: accountIds
          in: query
          description: "A comma-separated list of account IDs to filter transactions by."
          schema:
            type: array
            items:
              type: string
          style: form
          explode: false
          example: "acct_55pp66oo77ii88uu99,acct_abc123def456"
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
        - name: category
          in: query
          description: |-
            A string to filter transactions by category. This performs a case-insensitive search on Plaid's `detailedCategory`. To retrieve only internal transfers, use Plaid's official 'Transfer' category name.
          schema:
            type: string
            example: "Restaurants"
        - name: searchText
          in: query
          description: "A text string to perform a case-insensitive search across the transaction's **merchant name** and **detailed category** fields."
          schema:
            type: string
      responses:
        "200":
          description: A paginated list of transactions.
          content:
            application/json:
              schema:
                type: object
                properties:
                  pagination:
                    $ref: '#/components/schemas/Pagination'
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Transaction'
        "400":
          $ref: '#/components/responses/BadRequest'
        "401":
          $ref: '#/components/responses/Unauthorized'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /transactions/{transactionId}:
    patch:
      tags:
        - Transactions
      summary: Update a Transaction
      description: |-
        Updates one or more properties of a specific transaction.
        This is used to add user-defined notes or to re-categorize a transaction.
        The user must be the owner of the account to which the transaction belongs.
      operationId: updateTransaction
      parameters:
        - $ref: '#/components/parameters/TransactionId'
      requestBody:
        description: A JSON object containing only the fields to be updated.
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                notes:
                  type: string
                  nullable: true
                  description: "User-defined notes for the transaction. A null value will clear any existing notes."
                  maxLength: 500
                  example: "Split with Jane for dinner."
                userCategoryId:
                  type: string
                  nullable: true
                  description: "The ID of a user-defined category to override the one from Plaid. A null value will revert to Plaid's default category."
                  pattern: "^cat_usr_[a-zA-Z0-9]+$"
                  example: "cat_usr_9f8e7d6c5b4a"
              additionalProperties: false
              minProperties: 1
      responses:
        "200":
          description: The transaction was updated successfully. The full, updated transaction is returned.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'
        "400":
          $ref: '#/components/responses/BadRequest'
        "401":
          $ref: '#/components/responses/Unauthorized'
        "403":
          $ref: '#/components/responses/Forbidden'
        "404":
          $ref: '#/components/responses/NotFound'
        "500":
          $ref: '#/components/responses/InternalServerError'

  # --- Health Check ---
  /health:
    get:
      tags:
        - Health
      summary: System Health Check
      operationId: getHealth
      description: |-
        A public, unauthenticated endpoint to verify that the API service is running and can connect to its dependencies.
        Returns the operational status of the service.
      security: []
      responses:
        "200":
          description: The service is healthy.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "OK"
                  timestamp:
                    type: string
                    format: date-time

# ===============================================================================
# COMPONENTS - Reusable schemas, parameters, and responses.
# ===============================================================================
components:
  # --- Schemas (Data Models) ---
  schemas:
    Institution:
      type: object
      properties:
        id:
          type: string
          description: The unique ID for the Institution in our database.
          example: "inst_11xxyy22zz33aabb44"
        plaidInstitutionId:
          type: string
          description: The stable institution ID from Plaid.
          example: "ins_3"
        institutionName:
          type: string
          example: "Chase Bank"
        institutionLogo:
          type: string
          format: uri
          nullable: true
          description: A base64-encoded logo for the institution.
          example: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA..."
        syncStatus:
          type: string
          enum: [good, syncing, relink_required, error]
          example: "good"
        lastSuccessfulSync:
          type: string
          format: date-time
          nullable: true
          example: "2025-06-17T20:30:00.000Z"
        lastSyncErrorMessage:
          type: string
          nullable: true
          description: The error message from the last failed sync attempt.
          example: "ITEM_LOGIN_REQUIRED"
        archivedAt:
          type: string
          format: date-time
          nullable: true
          description: Timestamp when the institution was soft-deleted.
          example: "2025-06-18T10:00:00.000Z"

    InstitutionWithAccounts:
      allOf:
        - $ref: '#/components/schemas/Institution'
        - type: object
          properties:
            accounts:
              type: array
              items:
                $ref: '#/components/schemas/Account'

    Account:
      type: object
      properties:
        id:
          type: string
          description: The unique ID for the Account in our database.
          example: "acct_55pp66oo77ii88uu99"
        plaidAccountId:
          type: string
          description: The unique account ID from Plaid.
          example: "Bxp9pG1mpEtMmKqjK1EGFaVjv4qg74w7eB6lL"
        name:
          type: string
          example: "Primary Checking"
        mask:
          type: string
          example: "0766"
        type:
          type: string
          enum: [depository, credit, loan, investment, other]
          example: "depository"
        subtype:
          type: string
          example: "checking"
        currentBalance:
          type: number
          format: double
          example: 1250.75
        availableBalance:
          type: number
          format: double
          nullable: true
          example: 1200.50
        currencyCode:
          type: string
          example: "USD"
        creditLimit:
          type: number
          format: double
          nullable: true
          description: The credit limit for credit card accounts.
          example: 10000.00

    Transaction:
      type: object
      properties:
        id:
          type: string
          description: The unique ID for the transaction in our database.
          example: "txn_ff66aa77bb88cc99dd"
        plaidTransactionId:
          type: string
          description: The unique transaction ID from Plaid.
          example: "j1KnPo9a3pCpm4k3kG3KcoE5d7R6p7l5dEAZa"
        accountId:
          type: string
          description: The ID of the account this transaction belongs to.
          example: "acct_55pp66oo77ii88uu99"
        amount:
          type: number
          format: double
          example: -12.50
        currencyCode:
          type: string
          example: "USD"
        date:
          type: string
          format: date
          example: "2025-06-15"
        merchantName:
          type: string
          nullable: true
          example: "Starbucks"
        merchantLogo:
          type: string
          format: uri
          nullable: true
          description: The logo of the merchant, if available.
          example: "https://plaid-merchant-logos.plaid.com/starbucks_1060.png"
        primaryCategory:
          type: string
          nullable: true
          example: "Food and Drink"
        detailedCategory:
          type: string
          nullable: true
          example: "Restaurants"
        isPending:
          type: boolean
          example: false
        transactionType:
          type: string
          nullable: true
          description: "Transaction type from Plaid, e.g., 'special', 'place', 'digital'."
        paymentChannel:
          type: string
          nullable: true
          description: "The channel of the transaction, e.g., 'online', 'in store', 'other'."
        notes:
          type: string
          nullable: true
        userCategoryId:
          type: string
          nullable: true

    Pagination:
      type: object
      properties:
        offset:
          type: integer
          example: 0
        limit:
          type: integer
          example: 25
        total:
          type: integer
          example: 542

    ApiError:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              example: "RESOURCE_NOT_FOUND"
            message:
              type: string
              example: "The requested institution with ID 'inst_123' was not found."
            requestId:
              type: string
              description: A unique identifier for the request, useful for debugging and support.
              example: "a1b2c3d4-e5f6-7890-1234-567890abcdef"

  # --- Reusable Parameters ---
  parameters:
    InstitutionId:
      name: institutionId
      in: path
      required: true
      description: The unique identifier of the linked institution.
      schema:
        type: string
        example: "inst_11xxyy22zz33aabb44"

    TransactionId:
      name: transactionId
      in: path
      required: true
      description: The unique identifier of the transaction.
      schema:
        type: string
        example: "txn_ff66aa77bb88cc99dd"

  # --- Reusable Responses ---
  responses:
    BadRequest:
      description: Bad Request. The server could not process the request due to a client error (e.g., malformed syntax, invalid parameters).
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
    Unauthorized:
      description: Unauthorized. The request requires authentication, but the provided token was missing or invalid.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
    Forbidden:
      description: Forbidden. The authenticated user does not have permission to perform this action on the requested resource.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
    NotFound:
      description: Not Found. The requested resource could not be found on the server.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
    TooManyRequests:
      description: Rate limit exceeded. The client has sent too many requests in a given amount of time.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
    InternalServerError:
      description: Internal Server Error. An unexpected error occurred on the server that prevented it from fulfilling the request.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'

  # --- Security Schemes ---
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

##### tailwind.config.ts #####

import type { Config } from "tailwindcss";

export default {
  darkMode: ["class"],
  content: [
    "./client/index.html",
    "./client/src/**/*.{js,jsx,ts,tsx}",
    "./node_modules/flowbite-react/lib/**/*.{js,jsx,ts,tsx}"
  ],
  theme: {
    extend: {
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
      colors: {
        background: "hsl(var(--background))",
        foreground: "hsl(var(--foreground))",
        card: {
          DEFAULT: "hsl(var(--card))",
          foreground: "hsl(var(--card-foreground))",
        },
        popover: {
          DEFAULT: "hsl(var(--popover))",
          foreground: "hsl(var(--popover-foreground))",
        },
        primary: {
          DEFAULT: "hsl(var(--primary))",
          foreground: "hsl(var(--primary-foreground))",
        },
        secondary: {
          DEFAULT: "hsl(var(--secondary))",
          foreground: "hsl(var(--secondary-foreground))",
        },
        muted: {
          DEFAULT: "hsl(var(--muted))",
          foreground: "hsl(var(--muted-foreground))",
        },
        accent: {
          DEFAULT: "hsl(var(--accent))",
          foreground: "hsl(var(--accent-foreground))",
        },
        destructive: {
          DEFAULT: "hsl(var(--destructive))",
          foreground: "hsl(var(--destructive-foreground))",
        },
        border: "hsl(var(--border))",
        input: "hsl(var(--input))",
        ring: "hsl(var(--ring))",
        chart: {
          "1": "hsl(var(--chart-1))",
          "2": "hsl(var(--chart-2))",
          "3": "hsl(var(--chart-3))",
          "4": "hsl(var(--chart-4))",
          "5": "hsl(var(--chart-5))",
        },
        sidebar: {
          DEFAULT: "hsl(var(--sidebar-background))",
          foreground: "hsl(var(--sidebar-foreground))",
          primary: "hsl(var(--sidebar-primary))",
          "primary-foreground": "hsl(var(--sidebar-primary-foreground))",
          accent: "hsl(var(--sidebar-accent))",
          "accent-foreground": "hsl(var(--sidebar-accent-foreground))",
          border: "hsl(var(--sidebar-border))",
          ring: "hsl(var(--sidebar-ring))",
        },
      },
      keyframes: {
        "accordion-down": {
          from: {
            height: "0",
          },
          to: {
            height: "var(--radix-accordion-content-height)",
          },
        },
        "accordion-up": {
          from: {
            height: "var(--radix-accordion-content-height)",
          },
          to: {
            height: "0",
          },
        },
      },
      animation: {
        "accordion-down": "accordion-down 0.2s ease-out",
        "accordion-up": "accordion-up 0.2s ease-out",
      },
    },
  },
  plugins: [
    require("tailwindcss-animate"),
    require("@tailwindcss/typography"),
    require("flowbite/plugin")
  ],
} satisfies Config;

##### tsconfig.json #####

{
  "include": ["client/src/**/*", "shared/**/*", "server/**/*"],
  "exclude": ["node_modules", "build", "dist", "**/*.test.ts"],
  "compilerOptions": {
    "incremental": true,
    "tsBuildInfoFile": "./node_modules/typescript/tsbuildinfo",
    "noEmit": true,
    "module": "ESNext",
    "strict": true,
    "lib": ["esnext", "dom", "dom.iterable"],
    "jsx": "preserve",
    "esModuleInterop": true,
    "skipLibCheck": true,
    "allowImportingTsExtensions": true,
    "moduleResolution": "bundler",
    "baseUrl": ".",
    "types": ["node", "vite/client"],
    "paths": {
      "@/*": ["./client/src/*"],
      "@shared/*": ["./shared/*"]
    }
  }
}


##### vite.config.ts #####

import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";
import path from "path";
import { fileURLToPath } from 'url';
import runtimeErrorOverlay from "@replit/vite-plugin-runtime-error-modal";
import flowbiteReact from "flowbite-react/plugin/vite";

const __dirname = path.dirname(fileURLToPath(import.meta.url));

export default defineConfig({
  plugins: [
    react(),
    runtimeErrorOverlay(),
    ...(process.env.NODE_ENV !== "production" &&
    process.env.REPL_ID !== undefined
      ? [
          await import("@replit/vite-plugin-cartographer").then((m) =>
            m.cartographer(),
          ),
        ]
      : []),
    flowbiteReact()
  ],
  resolve: {
    alias: {
      "@": path.resolve(__dirname, "client", "src"),
      "@shared": path.resolve(__dirname, "shared"),
      "@assets": path.resolve(__dirname, "attached_assets"),
    },
  },
  root: path.resolve(__dirname, "client"),
  build: {
    outDir: path.resolve(__dirname, "dist/public"),
    emptyOutDir: true,
  },
});